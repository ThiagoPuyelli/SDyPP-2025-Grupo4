apiVersion: batch/v1
kind: Job
metadata:
  name: vault-bootstrap
  namespace: secret
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 600
  template:
    spec:
      serviceAccountName: vault-auth
      restartPolicy: Never
      securityContext:
        runAsNonRoot: true
        runAsUser: 100
        runAsGroup: 100
        fsGroup: 100
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: vault-bootstrap
          image: hashicorp/vault:1.15.4
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
          env:
            - name: VAULT_ADDR
              value: http://vault.secret.svc:8200
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: vault-admin
                  key: token
          envFrom:
            - secretRef:
                name: vault-env
          command:
            - /bin/sh
            - -c
            - |
              set -euo pipefail

              echo "Esperando a que Vault esté inicializado y desellado..."
              READY=0
              STATUS_JSON=""
              for i in $(seq 1 120); do
                STATUS_JSON="$(vault status -format=json 2>/dev/null || true)"
                if echo "${STATUS_JSON}" | grep -q '"initialized":[[:space:]]*true' && \
                   echo "${STATUS_JSON}" | grep -q '"sealed":[[:space:]]*false'; then
                  READY=1
                  break
                fi
                sleep 2
              done

              if [ "${READY}" -ne 1 ]; then
                echo "Vault no llegó al estado initialized=true y sealed=false."
                echo "${STATUS_JSON}"
                exit 1
              fi

              if echo "${STATUS_JSON}" | grep -q '"initialized":[[:space:]]*false'; then
                echo "Vault todavía no está inicializado."
                exit 1
              fi

              if echo "${STATUS_JSON}" | grep -q '"sealed":[[:space:]]*true'; then
                echo "Vault está sellado. Verificar auto-unseal."
                exit 1
              fi

              for required_var in RABBIT_USER RABBIT_PASS REDIS_DB POOL_PK; do
                required_val="$(eval "printf '%s' \"\${${required_var}:-}\"")"
                if [ -z "${required_val}" ]; then
                  echo "Falta la variable requerida ${required_var} en vault-env."
                  exit 1
                fi
              done

              echo "Habilitando y configurando el KV en secret/..."
              vault secrets enable -path=secret kv-v2 >/dev/null 2>&1 || true

              cat > /tmp/blockchain-policy.hcl <<'EOF'
              path "secret/data/blockchain" {
                capabilities = ["read"]
              }
              path "secret/data/blockchain/*" {
                capabilities = ["read"]
              }
              EOF
              vault policy write blockchain-policy /tmp/blockchain-policy.hcl

              cat > /tmp/pool-policy.hcl <<'EOF'
              path "secret/data/pool" {
                capabilities = ["read"]
              }
              path "secret/data/pool/*" {
                capabilities = ["read"]
              }
              EOF
              vault policy write pool-policy /tmp/pool-policy.hcl

              echo "Configurando autenticación Kubernetes..."
              vault auth enable kubernetes >/dev/null 2>&1 || true
              vault write auth/kubernetes/config \
                kubernetes_host="https://${KUBERNETES_SERVICE_HOST}:443" \
                kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt

              vault write auth/kubernetes/role/blockchain-role \
                bound_service_account_names="coordinador-sa,rabbitmq-sa" \
                bound_service_account_namespaces="blockchain" \
                policies="blockchain-policy" \
                ttl="24h"

              vault write auth/kubernetes/role/pool-role \
                bound_service_account_names="pool-sa" \
                bound_service_account_namespaces="pool" \
                policies="pool-policy" \
                ttl="24h"

              echo "Cargando secretos..."
              vault kv put secret/blockchain \
                RABBIT_USER="${RABBIT_USER}" \
                RABBIT_PASS="${RABBIT_PASS}" \
                REDIS_DB="${REDIS_DB}" \
                GRAFANA_USER="${GRAFANA_USER:-admin}" \
                GRAFANA_PASS="${GRAFANA_PASS:-admin}"

              POOL_PK_NORMALIZED="$(printf '%b' "${POOL_PK}")"
              vault kv put secret/pool \
                POOL_PK="${POOL_PK_NORMALIZED}"

              echo "Bootstrap de Vault terminado."
